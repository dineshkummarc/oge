var oge={version:1};oge.World=function(a,b,c){c=c||10;var d=this,e=new oge.Zones(a,b,c),f=new oge.Bodies(a,b,e),g=[];d.width=a,d.height=b,d.onCollision=f.onCollision,d.step=function(a){var b,c,d,e;a=arguments.length===0?1:a;for(b=0;b<a;b++)for(c=0;c<g.length;c++)e=g[c],d=e.direction,e.speed>0&&typeof d=="object"&&(d.cos!==0||d.sin!==0)&&f.moveBody(e)},d.addBody=function(a,b){return e.addBody(a)?(b&&g.push(a),!0):!1},d.removeBody=function(a){var b;e.removeBody(a);for(b=0;b<g.length;b++)if(g[b]===a){g.splice(b,1);break}}},oge.direction={rotate:function(a,b){if(typeof a=="object"){var c=b*Math.PI/180,d=a.cos*Math.cos(c)-a.sin*Math.sin(c),e=a.sin*Math.cos(c)+a.cos*Math.sin(c);return a.cos=d,a.sin=e,a}}},oge.Bodies=function(a,b,c){function f(a,b,c,d,e){return arguments.length===2&&(c=b.y,d=b.width,e=b.height,b=b.x),a.x<b+d&&a.x+a.width>b&&a.y<c+e&&a.y+a.height>c}function g(a,b,c,d,e){var f=Math.min(a.x+a.width,b+d)-Math.max(a.x,b),g=Math.min(a.y+a.height,c+e)-Math.max(a.y,c);return f*g}function h(a,b,c){var e,h,i,j,k,l,m,n,o;m=Math.atan2(Math.sin(Math.asin(b.sin)),Math.cos(Math.acos(b.cos))),n=Math.cos(m),o=Math.sin(m),e=function(b){var d,e,h,i,j=0,k=oge.direction.rotate({cos:n,sin:o},b);d=a.x+Math.round(k.cos),e=a.y+Math.round(k.sin);for(h=0;h<c.length;h++)i=c[h],f(i,d,e,a.width,a.height)&&(j+=g(i,d,e,a.width,a.height));return j},h=e(-90),i=e(-45),j=e(45),k=e(90),l=0;if(b.cos===0||b.sin===0){if(h!==k||i!==j)l=45,(h===0||k===0)&&Math.min(i,j)<Math.abs(n)*a.width+Math.abs(o)*a.height&&(i<j?l=-90:l=90)}else i===0?l=-45:j===0&&(l=45);l!==0&&d.moveBody(a,oge.direction.rotate({cos:n,sin:o},l),1)}var d=this,e={};d.width=a,d.height=b,d.onCollision=function(a,b){e[a]||(e[a]=[]),e[a].push(b)},d.moveBody=function(a,b,g){var i,j,k,l,m,n,o,p,q;arguments.length===1&&(b=a.direction,g=a.speed);for(n=0;n<g;n++){q=[],i=a.x,j=a.y,a.x+=Math.round(b.cos),a.y+=Math.round(b.sin);if(a.x>=0&&a.x+a.width<d.width&&a.y>=0&&a.y+a.height<d.height){m=c.getBodies(a);for(o=0;o<m.length;o++){k=m[o];if(a!==k&&!f(k,i,j,a.width,a.height)&&f(k,a)){if(e[a]){l={body1:a,body2:k};for(p=0;p<e[a].length;p++)e[a][p](l)}q.push(k)}}}else a.x=i,a.y=j;q.length>0&&(a.x=i,a.y=j),c.addBody(c,a);if(q.length>0)if(a.slide&&o>0)h(a,b,q);else return}}},oge.Zones=function(a,b,c){function f(a,b,f,g){var h,i,j,k,l=[];arguments.length===1&&(b=a.y,f=a.width,g=a.height,a=a.x);if(a>=0&&a+f-1<d.width&&b>=0&&b+g-1<d.height){h=Math.floor(a/c),i=Math.floor((a+f)/c),j=Math.floor(b/c),k=Math.floor((b+g)/c);for(a=h;a<=i;a++)for(b=j;b<=k;b++)l.push(e[a][b])}return l}var d=this,e=[];d.width=a,d.height=b,function(){var d,f,g=Math.floor(a/c+1),h=Math.floor(b/c+1);for(d=0;d<g;d++){e[d]=[];for(f=0;f<h;f++)e[d][f]={bodies:[]}}return e}(),d.addBody=function(a){var b,c=f(a);for(b=0;b<c.length;b++)c[b].bodies.push(a);return c.length>0},d.removeBody=function(a){var b,c,d=f(a);for(b=0;b<d.length;b++)for(c=0;c<d[b].bodies.length;c++)if(d[b].bodies[c]===a){d[b].bodies.splice(c,1);break}},d.getBodies=function(a,b,c,e){var g,h,i,j,k,l,m,n=[];arguments.length===1&&(b=a.y,c=a.width,e=a.height,a=a.x),a=a<0?0:a,a=a+c>d.width?d.width-c:a,b=b<0?0:b,b=b+e>d.height?d.height-e:b,g=f(a,b,c,e);for(k=0;k<g.length;k++){h=g[k].bodies;for(l=0;l<h.length;l++){i=h[l],j=!1;for(m=0;m<n.length;m++)if(n[m]===i){j=!0;break}j||n.push(i)}}return n}};