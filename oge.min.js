/*!
 * The MIT License
 *
 * Copyright (c) 2011 Eirik Brandtzæg
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *
 * @author Eirik Brandtzæg <eirikb@eirikb.no>
 * @Version 1.0
 */var oge={version:1};oge.World=function(a,b,c){c=c||10;var d=this,e=new oge.Zones(a,b,c),f=new oge.Bodies(a,b,e),g=[];d.width=a,d.height=b,d.onCollision=f.onCollision,d.step=function(a){var b,c,d,e;a=arguments.length===0?1:a;for(b=0;b<a;b++)for(c=0;c<g.length;c++)e=g[c],d=e.direction,e.speed>0&&typeof d=="object"&&(d.cos!==0||d.sin!==0)&&f.moveBody(e)},d.addBody=function(a,b){return e.addBody(a)?(b&&g.push(a),!0):!1},d.removeBody=function(a){var b;e.removeBody(a);for(b=0;b<g.length;b++)if(g[b]===a){g.splice(b,1);break}}},oge.direction={rotate:function(a,b){if(typeof a=="object"){var c=b*(Math.PI/180);a.cos=Math.cos(Math.acos(a.cos)+c),a.sin=Math.sin(Math.PI-Math.asin(a.sin)+c)}return a}},oge.Zones=function(a,b,c){function f(a,b,f,g){var h,i,j,k,l=[];arguments.length===1&&(b=a.y,f=a.width,g=a.height,a=a.x);if(a>=0&&a+f-1<d.width&&b>=0&&b+g-1<d.height){h=Math.floor(a/c),i=Math.floor((a+f)/c),j=Math.floor(b/c),k=Math.floor((b+g)/c);for(a=h;a<=i;a++)for(b=j;b<=k;b++)l.push(e[a][b])}return l}var d=this,e=[];d.width=a,d.height=b,function(){var d,f,g=Math.floor(a/c+1),h=Math.floor(b/c+1);for(d=0;d<g;d++){e[d]=[];for(f=0;f<h;f++)e[d][f]={bodies:[]}}return e}(),d.addBody=function(a){var b,c=f(a);for(b=0;b<c.length;b++)c[b].bodies.push(a);return c.length>0},d.removeBody=function(a){var b,c,d=f(a);for(b=0;b<d.length;b++)for(c=0;c<d[b].bodies.length;c++)if(d[b].bodies[c]===a){d[b].bodies.splice(c,1);break}},d.getBodies=function(a,b,c,e){var g,h,i,j,k,l,m,n=[];arguments.length===1&&(b=a.y,c=a.width,e=a.height,a=a.x),a=a<0?0:a,a=a+c>d.width?d.width-c:a,b=b<0?0:b,b=b+e>d.height?d.height-e:b,g=f(a,b,c,e);for(k=0;k<g.length;k++){h=g[k].bodies;for(l=0;l<h.length;l++){i=h[l],j=!1;for(m=0;m<n.length;m++)if(n[m]===i){j=!0;break}j||n.push(i)}}return n}},oge.Bodies=function(a,b,c){function f(a,b){var d,e,f,g,j,k,l,m=[],n=c.getBodies(a);for(e=0;e<n.length;e++)k=n[e],k!==a&&h(a,k)&&m.push(k);d=0,g=a.x+Math.round(b.cos),j=a.y+Math.round(b.sin),n=c.getBodies(g,j,a.width,a.height);for(e=0;e<n.length;e++){k=n[e];if(k!==a&&h(k,g,j,a.width,a.height)){l=!1;for(f=0;f<m.length;f++)if(k===m[f]){l=!0;break}l||(d+=i(k,g,j,a.width,a.height))}}return Math.floor(d)}function g(a,b){var c,e,g,h,i,j,k,l,m,n=Number.MAX,o=[-45,45,-90,90];j=Math.atan2(Math.sin(Math.asin(b.sin)),Math.cos(Math.acos(b.cos))),k=Math.cos(j),l=Math.sin(j),calc=function(b){var c=oge.direction.rotate({cos:k,sin:l},b);return f(a,c)},c=calc(-90),e=calc(-45),g=calc(45),h=calc(90),i=0;if(b.cos===0||b.sin===0)if(c!==h||e!==g)i=45,(c===0||h===0)&&Math.min(e,g)<Math.abs(k)*a.width+Math.abs(l)*a.height&&(e<g?i=-90:i=90);i!==0&&d.moveBody(a,oge.direction.rotate({cos:k,sin:l},i),1)}function h(a,b,c,d,e){return arguments.length===2&&(c=b.y,d=b.width,e=b.height,b=b.x),a.x<b+d&&a.x+a.width>b&&a.y<c+e&&a.y+a.height>c}function i(a,b,c,d,e){var f=Math.min(a.x+a.width,b+d)-Math.max(a.x,b),g=Math.min(a.y+a.height,c+e)-Math.max(a.y,c);return f*g}var d=this,e={};d.width=a,d.height=b,d.onCollision=function(a,b){e[a]||(e[a]=[]),e[a].push(b)},d.moveBody=function(a,b,f){var i,j,k,l,m,n,o,p;arguments.length===1&&(b=a.direction,f=a.speed);for(n=0;n<f;n++){i=a.x,j=a.y,a.x+=Math.round(b.cos),a.y+=Math.round(b.sin);if(a.x>=0&&a.x+a.width<d.width&&a.y>=0&&a.y+a.height<d.height){m=c.getBodies(a);for(o=0;o<m.length;o++){k=m[o];if(a!==k&&!h(k,i,j,a.width,a.height)&&h(k,a)){if(e[a]){l={body1:a,body2:k};for(p=0;p<e[a].length;p++)e[a][p](l)}a.x=i,a.y=j,c.addBody(c,a);if(a.slide&&o>=0)g(a,b);else return}}}else a.x=i,a.y=j;c.addBody(c,a)}}};